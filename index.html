<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tiny Garden Ultimate ‚Äî Gardening 2.0 + Freeroam</title>
<style>
  :root{
    --accent:#27ae60; --accent-2:#1e8449; --muted:#6b7280;
    --bg-day1:#e9fff0; --bg-day2:#c9f6d7; --card:#ffffffee;
    --radius:12px; --tile-size:64px;
    font-family:Inter, system-ui, -apple-system,"Segoe UI",Roboto,Arial;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  html,body{height:100%}
  body{min-height:100vh;display:flex;justify-content:center;align-items:center;
    background:linear-gradient(180deg,var(--bg-day1),var(--bg-day2));padding:18px}
  .app{width:1200px;max-width:98vw;display:grid;grid-template-columns:360px 1fr;gap:16px;background:var(--card);border-radius:14px;box-shadow:0 18px 60px rgba(8,30,12,0.12);overflow:hidden;min-height:780px}
  .sidebar{padding:16px;display:flex;flex-direction:column;gap:12px;background:linear-gradient(180deg,#fff,#f7fff7)}
  .brand{font-weight:900;color:var(--accent-2);display:flex;align-items:center;gap:10px}
  .hud{display:flex;gap:8px;flex-wrap:wrap}
  .badge{background:#f5fff6;padding:8px 10px;border-radius:10px;font-weight:800;color:var(--accent-2)}
  .section{background:#f6fff7;border-radius:10px;padding:8px}
  .listItem{padding:8px;margin-top:8px;background:#eaf9ec;border-radius:10px;display:flex;align-items:center;justify-content:space-between}
  button{padding:8px 12px;border-radius:10px;border:none;background:linear-gradient(180deg,var(--accent),var(--accent-2));color:white;cursor:pointer}
  button.small{padding:6px 8px;font-size:13px}
  .muted{color:var(--muted);font-size:13px}

  .panel{padding:16px;display:flex;flex-direction:column;gap:12px}
  .sky{height:110px;border-radius:10px;position:relative;overflow:hidden;background:linear-gradient(180deg,transparent,transparent)}
  .sun{position:absolute;right:18px;top:18px;width:64px;height:64px;border-radius:50%;background:radial-gradient(circle at 30% 30%,#fff9c8,#ffd76b)}
  .inner{display:flex;gap:12px;align-items:stretch}

  .gameArea{flex:1;display:flex;flex-direction:column;gap:12px}
  .controlsBar{display:flex;justify-content:space-between;align-items:center}
  .gridWrap{background:linear-gradient(180deg,#eaf8ec,#d8f4d8);padding:12px;border-radius:12px;flex:1;display:flex;flex-direction:column}
  .toolbar{display:flex;gap:8px;align-items:center}

  /* garden grid */
  .gardenGrid{display:grid;grid-template-columns:repeat(6,1fr);gap:12px;padding:8px;align-items:end}
  .plot{height:120px;border-radius:12px;background:linear-gradient(180deg,#f9fff9,#e9f8e9);position:relative;cursor:pointer;box-shadow:inset 0 4px 10px rgba(0,0,0,0.03),0 6px 18px rgba(0,0,0,0.05);transition:transform .12s;display:flex;align-items:flex-end;justify-content:center;overflow:visible}
  .plot:hover{transform:translateY(-6px)}
  .soil{position:absolute;left:6px;right:6px;bottom:4px;height:36px;border-bottom-left-radius:10px;border-bottom-right-radius:10px;background:linear-gradient(180deg,#8a5a36,#5b3216);box-shadow:inset 0 4px 8px rgba(0,0,0,0.18)}
  .soil.poor{background:linear-gradient(180deg,#6b4b30,#4a2a12)}
  .soil.rich{background:linear-gradient(180deg,#996133,#6b3f1d)}
  .plant{position:absolute;bottom:66px;font-size:28px;opacity:0;transform:translateY(8%) scale(.95);transition:all .35s}
  .plant.show{opacity:1;transform:translateY(0) scale(1)}
  .waterBadge{position:absolute;top:8px;right:8px;background:rgba(255,255,255,0.9);padding:4px 6px;border-radius:8px;font-weight:700;font-size:12px}
  .weed{position:absolute;top:8px;left:8px;font-size:16px}
  .pest{position:absolute;top:8px;left:8px;font-size:18px}
  .progress{position:absolute;bottom:10px;height:8px;width:76%;background:rgba(0,0,0,0.06);border-radius:6px}
  .progressFill{height:100%;width:0;background:linear-gradient(90deg,var(--accent),var(--accent-2));border-radius:6px;transition:width .18s}

  /* per-plot control overlay */
  .plotControls{position:absolute;left:8px;bottom:46px;display:flex;gap:6px;z-index:5}
  .plotControls button{padding:6px;border-radius:8px;font-size:12px}

  .inventory{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .invItem{background:#fff;padding:6px 8px;border-radius:8px;border:1px solid rgba(0,0,0,0.04);font-weight:700}

  /* freeroam map */
  .freeroamWrap{display:none;flex-direction:column;gap:8px}
  .mapWrap{background:linear-gradient(180deg,#eef8ef,#ddf2df);border-radius:12px;padding:12px;display:flex;gap:12px}
  .map{width:calc(var(--tile-size)*14);height:calc(var(--tile-size)*9);background:linear-gradient(180deg,#d8f4d8,#c8eac8);border-radius:10px;display:grid;grid-template-columns:repeat(14,var(--tile-size));grid-template-rows:repeat(9,var(--tile-size));gap:2px;position:relative;user-select:none}
  .tile{width:var(--tile-size);height:var(--tile-size);border-radius:8px;background-size:cover;background-position:center}
  .tile.grass{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect fill="%23bdebb7" width="64" height="64"/></svg>')}
  .tile.path{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect fill="%23e6d7b8" width="64" height="64"/></svg>')}
  .tile.shop{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect fill="%23fff1c8" width="64" height="64"/></svg>')}
  .player{position:absolute;width:46px;height:46px;border-radius:10px;background:linear-gradient(180deg,#fff,#f8d6b1);display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 8px 18px rgba(0,0,0,0.12);transform:translate(-50%,-50%);transition:left .12s,top .12s}
  .npc{position:absolute;width:44px;height:44px;border-radius:10px;background:linear-gradient(180deg,#fff,#ffdce0);display:flex;align-items:center;justify-content:center;font-size:20px;box-shadow:0 6px 14px rgba(0,0,0,0.12);transform:translate(-50%,-50%);cursor:pointer;transition:left .12s,top .12s}
  .tile.hiddenItem{box-shadow:0 0 18px rgba(255,215,0,0.9) inset}
  .dialogBox{position:fixed;left:50%;top:64%;transform:translate(-50%,-50%);background:white;padding:12px;border-radius:10px;box-shadow:0 12px 40px rgba(0,0,0,0.18);z-index:9999;max-width:520px}
  .hidden{display:none}

  /* small screen */
  @media(max-width:1000px){
    .app{grid-template-columns:1fr}
    .map{width:calc(var(--tile-size)*9);grid-template-columns:repeat(9,var(--tile-size));grid-template-rows:repeat(6,var(--tile-size));height:calc(var(--tile-size)*6)}
    .gardenGrid{grid-template-columns:repeat(4,1fr)}
  }
</style>
</head>
<body>
  <div class="app" id="app">
    <div class="sidebar">
      <div class="brand">üåº Tiny Garden Ultimate ‚Äî Gardening 2.0</div>

      <div class="hud">
        <div class="badge">Money: $<span id="money">50</span></div>
        <div class="badge">Seeds: <span id="seeds">5</span></div>
        <div class="badge">Pots: <span id="pots">6</span></div>
        <div class="badge">Water Charges: <span id="waterCharges">0</span></div>
        <div class="badge">Fertilizers: <span id="fertCount">0</span></div>
      </div>

      <div class="section">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div style="font-weight:800">Mode</div>
          <div style="display:flex;gap:8px">
            <button id="btnGarden" class="small">üå± Garden</button>
            <button id="btnFreeroam" class="small ghost">üåç Freeroam</button>
          </div>
        </div>

        <div style="margin-top:10px">
          <div style="font-weight:700;margin-bottom:6px">Plant Selector</div>
          <div id="plantSelector"></div>
        </div>
      </div>

      <div class="section">
        <div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:700">Shop</div><small class="muted">buy tools & supplies</small></div>
        <div id="shopList" style="margin-top:8px"></div>
      </div>

      <div class="section">
        <div style="display:flex;justify-content:space-between;align-items:center"><div style="font-weight:700">Quests</div><small class="muted">Town & NPC</small></div>
        <div id="npcQuests" style="margin-top:8px"></div>
      </div>

      <div style="display:flex;gap:8px">
        <button id="saveBtn" class="small">üíæ Save</button>
        <button id="resetBtn" class="small ghost">üîÅ Reset</button>
      </div>

      <div class="section">
        <div style="font-weight:700">Inventory</div>
        <div class="inventory" id="inventory"></div>
        <div style="margin-top:8px" class="muted">Harvested crops and items are stored here.</div>
      </div>

      <div class="section">
        <div style="font-weight:700">Log</div>
        <div id="log" style="margin-top:8px;max-height:220px;overflow:auto" class="muted"></div>
      </div>
    </div>

    <div class="panel">
      <div class="sky"><div class="sun" id="sun"></div></div>

      <div class="inner">
        <div class="gameArea" id="gameArea">
          <!-- Garden -->
          <div id="gardenArea">
            <div class="controlsBar">
              <div class="toolbar">
                <button id="btnHarvestAll" class="small ghost">Harvest All</button>
                <button id="btnOpenTown" class="small">Go to Town</button>
                <button id="btnBuyWater" class="small">Buy Water Can (+3) $8</button>
              </div>
              <div class="toolbar muted">Click plots to plant/grow. Use water & fertilizer to speed growth.</div>
            </div>

            <div class="gridWrap" id="gardenWrap">
              <div style="display:flex;justify-content:space-between;align-items:center">
                <div style="font-weight:800">Garden</div>
                <div id="seasonBadge" class="muted"></div>
              </div>
              <div class="gardenGrid" id="gardenGrid"></div>

              <div style="display:flex;justify-content:space-between;align-items:center;margin-top:8px">
                <div>
                  <small class="muted">Tools:</small>
                  <button id="btnUseWater" class="small">üíß Water (use charge)</button>
                  <button id="btnUseFert" class="small">üåø Fertilize</button>
                  <button id="btnScarecrow" class="small ghost">Place Scarecrow ($40)</button>
                </div>
                <div>
                  <small class="muted">Soil Upgrades:</small>
                  <button id="btnUpgradeSoil" class="small ghost">Upgrade a plot ($6)</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Freeroam -->
          <div id="freeroamArea" class="freeroamWrap">
            <div style="display:flex;justify-content:space-between;align-items:center">
              <div style="font-weight:800">Freeroam Town</div>
              <div style="display:flex;gap:8px;align-items:center">
                <button id="btnReturnGarden" class="small ghost">Return to Garden</button>
                <div class="muted">Move: WASD / Arrow keys or click tiles</div>
              </div>
            </div>

            <div class="mapWrap">
              <div id="map" class="map" tabindex="0" aria-label="Town map"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="dialog" class="dialogBox hidden"></div>
  <div id="toastWrap" class="toastWrap"></div>

<script>
/* ---------- Gardening 2.0 + Freeroam Single File ---------- */

/* ---------- Data ---------- */
const PLANTS = {
  carrot:     { emoji:'ü•ï', growthStages:3, reward:2, seedCost:1, seasons:['spring','summer','autumn'] },
  strawberry: { emoji:'üçì', growthStages:3, reward:5, seedCost:2, seasons:['spring','summer'] },
  apple:      { emoji:'üçé', growthStages:6, reward:15, seedCost:6, seasons:['summer','autumn'] },
  corn:       { emoji:'üåΩ', growthStages:4, reward:6, seedCost:2, seasons:['summer'] },
  grapes:     { emoji:'üçá', growthStages:5, reward:10, seedCost:3, seasons:['summer','autumn'] },
  pumpkin:    { emoji:'üéÉ', growthStages:7, reward:22, seedCost:8, seasons:['autumn'] }
};

const SHOP = [
  { id:'seed', name:'Extra Seed', cost:5, action: s=> s.seeds++ },
  { id:'pot', name:'Extra Pot', cost:10, action: s=> { s.pots++; ensurePlots(); } },
  { id:'waterCan', name:'Water Can (+3 charges)', cost:8, action: s=> { s.waterCharges = (s.waterCharges||0) + 3; } },
  { id:'fertBag', name:'Fertilizer Bag (+1 use)', cost:6, action: s=> { s.fertCount = (s.fertCount||0) + 1; } },
  { id:'betterCan', name:'Better Water Can (waters 3 plots)', cost:30, action: s=> s.betterCan = true },
  { id:'scarecrow', name:'Scarecrow (prevents pests nearby)', cost:40, action: s=> s.hasScarecrow = true }
];

const MAP_COLUMNS = 14, MAP_ROWS = 9;

/* ---------- State ---------- */
const STORAGE_KEY = 'tinyGarden_garden2_v1';
const DEFAULT_STATE = {
  money:50, seeds:8, pots:6, plots:[], inventory:{}, quests:[], waterCharges:0, fertCount:0, betterCan:false, hasScarecrow:false,
  freeroam:{ player:{col:3,row:3}, hiddenItems:[] }, device:'pc'
};
let state = loadState() || JSON.parse(JSON.stringify(DEFAULT_STATE));

/* ---------- Utilities ---------- */
function loadState(){ try{ const s = localStorage.getItem(STORAGE_KEY); return s ? JSON.parse(s): null } catch(e){ return null } }
function saveState(){ try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); toast('Saved'); } catch(e){ console.warn(e); } }
function toast(txt,ms=1400){ const tw=document.getElementById('toastWrap'); const t=document.createElement('div'); t.className='toast'; t.textContent=txt; tw.appendChild(t); requestAnimationFrame(()=>t.classList.add('show')); setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(),300); }, ms); }
function log(msg){ const el=document.getElementById('log'); const now=new Date(); const row=document.createElement('div'); row.textContent=`[${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}] ${msg}`; el.prepend(row); }

/* ---------- Garden core ---------- */
const gardenGridEl = document.getElementById('gardenGrid');
function makePlot(){ return { planted:false, plantKey:null, growth:0, water:0, soilQuality:'normal', pest:false, weed:false } }
function ensurePlots(){ while(state.plots.length < state.pots) state.plots.push(makePlot()); while(state.plots.length > state.pots) state.plots.pop(); }

let selectedPlantKey = Object.keys(PLANTS)[0];

/* seasons */
function currentSeason(){
  const m = new Date().getMonth()+1;
  if(m>=3 && m<=5) return 'spring';
  if(m>=6 && m<=8) return 'summer';
  if(m>=9 && m<=11) return 'autumn';
  return 'winter';
}

/* build plant selector */
function buildPlantSelector(){
  const sel = document.getElementById('plantSelector'); sel.innerHTML='';
  for(const k in PLANTS){
    const p = PLANTS[k];
    const div = document.createElement('div'); div.className='listItem';
    const seasonOk = PLANTS[k].seasons.includes(currentSeason());
    div.innerHTML = `<div style="display:flex;gap:8px;align-items:center"><div style="font-size:18px">${p.emoji}</div><div style="text-transform:capitalize">${k}${seasonOk? '':' (off-season)'}</div></div><div>${p.seedCost} seed</div>`;
    div.addEventListener('click', ()=>{ selectedPlantKey = k; Array.from(sel.children).forEach(c=>c.style.boxShadow=''); div.style.boxShadow='inset 0 0 0 3px rgba(39,154,82,0.12)'; toast('Selected '+k); });
    sel.appendChild(div);
  }
  sel.firstChild && (sel.firstChild.style.boxShadow='inset 0 0 0 3px rgba(39,154,82,0.12)');
}

/* render garden */
function renderGarden(){
  ensurePlots();
  const season = currentSeason();
  document.getElementById('seasonBadge').textContent = 'Season: '+season.toUpperCase();
  gardenGridEl.innerHTML='';
  state.plots.forEach((plot,i)=>{
    const div = document.createElement('div'); div.className='plot'; div.addEventListener('click', ()=> onPlotClick(i));
    // soil visual
    const soil = document.createElement('div'); soil.className='soil';
    if(plot.soilQuality === 'poor') soil.classList.add('poor');
    if(plot.soilQuality === 'rich') soil.classList.add('rich');
    div.appendChild(soil);
    // weed
    if(plot.weed){ const w=document.createElement('div'); w.className='weed'; w.textContent='üåø'; div.appendChild(w); }
    // pest
    if(plot.pest){ const p=document.createElement('div'); p.className='pest'; p.textContent='üêõ'; p.title='Click to remove'; p.addEventListener('click', e=>{ e.stopPropagation(); removePest(i); }); div.appendChild(p); }
    // planted
    if(plot.planted){
      const pEl = document.createElement('div'); pEl.className='plant';
      const frac = plot.growth / PLANTS[plot.plantKey].growthStages;
      if(frac < 0.4) pEl.classList.add('small'); else if(frac < 0.9) pEl.classList.add('medium'); else pEl.classList.add('large');
      pEl.textContent = PLANTS[plot.plantKey].emoji; div.appendChild(pEl); setTimeout(()=>pEl.classList.add('show'), 10);
      const prog = document.createElement('div'); prog.className='progress'; const pf=document.createElement('div'); pf.className='progressFill';
      const pct = Math.min(100, Math.round((plot.growth / PLANTS[plot.plantKey].growthStages)*100));
      pf.style.width = pct + '%'; prog.appendChild(pf); div.appendChild(prog);
    }
    // water badge
    const waterBadge = document.createElement('div'); waterBadge.className='waterBadge'; waterBadge.textContent = 'üíß'+(plot.water||0);
    div.appendChild(waterBadge);

    // per-plot controls overlay (water / fertilize / remove weed)
    const controls = document.createElement('div'); controls.className='plotControls';
    const waterBtn = document.createElement('button'); waterBtn.textContent='üíß'; waterBtn.title='Water plot';
    waterBtn.addEventListener('click', (e)=>{ e.stopPropagation(); waterPlot(i); });
    const fertBtn = document.createElement('button'); fertBtn.textContent='üåø'; fertBtn.title='Fertilize';
    fertBtn.addEventListener('click', (e)=>{ e.stopPropagation(); fertilizePlot(i); });
    const weedBtn = document.createElement('button'); weedBtn.textContent='‚úÇÔ∏è'; weedBtn.title='Remove weed';
    weedBtn.addEventListener('click', (e)=>{ e.stopPropagation(); removeWeed(i); });
    controls.appendChild(waterBtn); controls.appendChild(fertBtn); controls.appendChild(weedBtn);
    div.appendChild(controls);

    gardenGridEl.appendChild(div);
  });
  updateInventoryUI(); updateHUD(); renderNpcQuests();
}

/* plot click: plant or grow */
function onPlotClick(i){
  const plot = state.plots[i];
  // if empty: plant
  if(!plot.planted){
    const seedCost = PLANTS[selectedPlantKey].seedCost;
    if(state.seeds >= seedCost){
      // check season preference: allow planting but slower if off-season
      state.seeds -= seedCost;
      plot.planted = true; plot.plantKey = selectedPlantKey; plot.growth = 0; plot.water = 0;
      log('Planted '+selectedPlantKey);
      toast('Planted '+selectedPlantKey);
      maybeSpawnWeed(i); maybeSpawnPest(i);
      progressQuestProgress('plant', selectedPlantKey);
      saveSoon(); renderGarden();
    } else toast('Not enough seeds');
  } else {
    // attempt to grow: if water >=1 or fertilizer used
    if(plot.weed){ toast('Remove weeds first'); return; }
    if(plot.pest){ toast('Remove pest first'); return; }
    // Season influence: if off-season growth requires +1 water to progress
    const season = currentSeason();
    const offSeason = !PLANTS[plot.plantKey].seasons.includes(season);
    const soil = plot.soilQuality || 'normal';
    const soilBonus = soil === 'rich' ? 0 : soil === 'poor' ? 1 : 0; // extra water needed for poor soil
    const neededWater = 1 + (offSeason?1:0) + soilBonus;
    if(plot.water >= neededWater){
      plot.growth++;
      plot.water = Math.max(0, plot.water - neededWater);
      log('Growth +1 for '+plot.plantKey);
      if(plot.growth >= PLANTS[plot.plantKey].growthStages){
        // harvest: add to inventory, money adjusted for soil and pests
        let base = PLANTS[plot.plantKey].reward;
        if(plot.soilQuality === 'rich') base = Math.round(base * 1.2);
        if(plot.soilQuality === 'poor') base = Math.max(1, Math.round(base * 0.8));
        if(plot.pest) base = Math.max(0, Math.round(base * 0.6)); // pests reduce value
        state.inventory[plot.plantKey] = (state.inventory[plot.plantKey]||0) + 1;
        state.money += base;
        state.harvested = (state.harvested||0) + 1;
        log(`Harvested ${plot.plantKey} -> +1 inventory, +$${base}`);
        toast(`Harvested ${plot.plantKey} +$${base}`);
        progressQuestProgress('harvest', plot.plantKey);
        // reset plot
        plot.planted=false; plot.plantKey=null; plot.growth=0; plot.water=0; plot.pest=false; plot.weed=false;
        saveSoon(); renderGarden(); return;
      }
      saveSoon(); renderGarden();
    } else {
      // not enough water: small chance to grow anyway but lower
      if(Math.random() < 0.1){
        plot.growth++;
        toast('Lucky growth despite low water!');
        if(plot.growth >= PLANTS[plot.plantKey].growthStages){
          state.inventory[plot.plantKey] = (state.inventory[plot.plantKey]||0) + 1;
          state.money += PLANTS[plot.plantKey].reward;
          log('Harvested (lucky) '+plot.plantKey);
          plot.planted=false; plot.plantKey=null; plot.growth=0; plot.water=0;
          saveSoon(); renderGarden(); return;
        }
        saveSoon(); renderGarden();
      } else {
        toast('Needs water to grow (use plot water button)');
      }
    }
  }
}

/* water / fertilize / weed / pest functions */
function waterPlot(i){
  if(state.waterCharges && state.waterCharges>0){
    // betterCan waters 3 plots including neighbors; otherwise single plot
    const plot = state.plots[i];
    state.waterCharges--;
    let affected = 0;
    if(state.betterCan){
      // water i and up to two neighbors (left/right)
      [i-1,i,i+1].forEach(idx => { if(state.plots[idx]){ state.plots[idx].water = (state.plots[idx].water||0) + 1; affected++; } });
    } else {
      plot.water = (plot.water||0) + 1; affected = 1;
    }
    log('Water used on plot(s) x'+affected);
    toast(`Watered ${affected} plot(s)`);
    progressQuestProgress('water', null);
    saveSoon(); renderGarden();
  } else {
    toast('No water charges. Buy Water Can in shop or open a can.');
  }
}

function fertilizePlot(i){
  if(state.fertCount && state.fertCount>0){
    const plot = state.plots[i];
    state.fertCount--;
    plot.growth = Math.min(PLANTS[plot.plantKey]?.growthStages || plot.growth + 1, PLANTS[plot.plantKey]?.growthStages || plot.growth + 1);
    // fertilizer increases soil richness outcome
    plot.soilQuality = (plot.soilQuality === 'rich') ? 'rich' : 'rich';
    toast('Fertilized plot');
    log('Fertilizer used');
    saveSoon(); renderGarden();
  } else {
    toast('No fertilizer. Buy from shop.');
  }
}

function removeWeed(i){
  if(state.plots[i] && state.plots[i].weed){
    state.plots[i].weed = false;
    log('Weed removed');
    toast('Weed removed');
    saveSoon(); renderGarden();
  } else toast('No weeds there');
}

function removePest(i){
  if(state.plots[i] && state.plots[i].pest){
    state.plots[i].pest = false;
    state.money += 1;
    log('Pest removed +$1');
    toast('Pest removed +$1');
    saveSoon(); renderGarden();
  } else toast('No pest here');
}

/* random weeds/pests spawning */
function maybeSpawnWeed(i){
  if(Math.random() < 0.12){ state.plots[i].weed = true; toast('Weeds appeared'); saveSoon(); renderGarden(); }
}
function maybeSpawnPest(i){
  const sc = state.hasScarecrow ? 0.08 : 0.25;
  setTimeout(()=>{
    if(Math.random() < sc && state.plots[i] && state.plots[i].planted && !state.plots[i].pest){
      state.plots[i].pest = true; toast('Pest appeared'); saveSoon(); renderGarden();
    }
  }, 1500 + Math.random()*3000);
}

/* Upgrade soil for a plot: pay $6, set to rich */
function upgradeSoil(plotIndex){
  if(state.money >= 6){
    state.money -= 6; state.plots[plotIndex].soilQuality = 'rich'; toast('Soil upgraded'); log('Soil upgraded'); saveSoon(); renderGarden();
  } else toast('Not enough money');
}

/* ---------- Inventory UI ---------- */
function updateInventoryUI(){
  const inv = document.getElementById('inventory'); inv.innerHTML='';
  for(const k in PLANTS){
    const cnt = state.inventory[k] || 0;
    const box = document.createElement('div'); box.className='invItem';
    box.textContent = `${PLANTS[k].emoji} ${k}: ${cnt}`;
    inv.appendChild(box);
  }
  // also show generic items
  const w = document.createElement('div'); w.className='invItem'; w.textContent = `WaterCharges: ${state.waterCharges||0}`; inv.appendChild(w);
  const f = document.createElement('div'); f.className='invItem'; f.textContent = `Fert: ${state.fertCount||0}`; inv.appendChild(f);
}

/* ---------- Shop ---------- */
function renderShop(){
  const list = document.getElementById('shopList'); list.innerHTML='';
  SHOP.forEach(s=>{
    const row = document.createElement('div'); row.className='listItem';
    row.innerHTML = `<div>${s.name}</div><div style="display:flex;gap:8px;align-items:center"><div>$${s.cost}</div><button data-id="${s.id}" class="small">Buy</button></div>`;
    list.appendChild(row);
  });
  list.querySelectorAll('button[data-id]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.dataset.id; const item = SHOP.find(x=>x.id===id);
      if(!item) return;
      if(state.money >= item.cost){ state.money -= item.cost; item.action(state); toast('Bought '+item.name); log('Bought '+item.name); saveSoon(); renderGarden(); renderShop(); updateInventoryUI(); } else toast('Not enough money');
    });
  });
}

/* ---------- Quests & NPCs (Garden) ---------- */
function renderNpcQuests(){
  const el = document.getElementById('npcQuests'); el.innerHTML='';
  state.quests.forEach((q,i)=>{
    const row = document.createElement('div'); row.className='listItem';
    row.innerHTML = `<div><b>${q.npc}</b> wants ${q.qty} ${PLANTS[q.want].emoji} ${q.want}</div><div>${q.claimed? 'Done' : (state.inventory[q.want]||0)+'/'+q.qty}</div>`;
    if(!q.claimed){
      const claimBtn = document.createElement('button'); claimBtn.textContent='Give'; claimBtn.className='small';
      claimBtn.addEventListener('click', ()=> tryCompleteQuest(i));
      row.appendChild(claimBtn);
    }
    el.appendChild(row);
  });
}

/* complete quest */
function tryCompleteQuest(idx){
  const q = state.quests[idx];
  if(!q || q.claimed) return;
  const have = state.inventory[q.want] || 0;
  if(have >= q.qty){
    state.inventory[q.want] -= q.qty; q.claimed = true; state.money += q.reward;
    toast('Quest complete! +$'+q.reward); log('Quest complete: '+q.npc+' paid $'+q.reward);
    saveSoon(); renderNpcQuests(); renderGarden(); updateInventoryUI(); updateHUD();
  } else toast('Not enough items for quest');
}

/* progress quests automatically when harvesting */
function progressQuestProgress(action, plantKey){
  // change progress to match inventory counts
  state.quests.forEach(q=>{
    if(q.claimed) return;
    if(q.want === plantKey){
      q.progress = Math.min(q.qty, state.inventory[q.want] || 0);
      if(q.progress >= q.qty) q.ready = true;
    }
  });
  renderNpcQuests();
}

/* ---------- Freeroam: map, player, NPCs, shops & hidden items ---------- */
const mapEl = document.getElementById('map');
let freeroamActive = false;
function buildMapTiles(){
  mapEl.innerHTML='';
  for(let r=0;r<MAP_ROWS;r++){
    for(let c=0;c<MAP_COLUMNS;c++){
      const t = document.createElement('div'); t.className='tile grass';
      if(r===4 && c>=2 && c<=11) t.className='tile path';
      if(r===2 && c===11) t.className='tile shop';
      if(r===7 && c===2) t.className='tile water';
      t.dataset.col=c; t.dataset.row=r;
      t.addEventListener('click', ()=> movePlayerTo(c,r));
      mapEl.appendChild(t);
    }
  }
  // place hidden items randomly if not present
  if(!state.freeroam.hiddenItems || state.freeroam.hiddenItems.length===0){
    state.freeroam.hiddenItems = [];
    for(let i=0;i<6;i++){
      state.freeroam.hiddenItems.push({col: 2 + Math.floor(Math.random()*(MAP_COLUMNS-4)), row: 1 + Math.floor(Math.random()*(MAP_ROWS-2)), found:false, type: Math.random()<0.6? 'seeds':'coins'});
    }
  }
  // mark hidden items visually
  state.freeroam.hiddenItems.forEach((h,idx)=>{
    if(h.found) return;
    const tileIndex = h.row*MAP_COLUMNS + h.col;
    const tile = mapEl.children[tileIndex];
    if(tile) tile.classList.add('hiddenItem');
  });
}

let playerEl = null;
function placePlayer(){
  if(!playerEl){ playerEl = document.createElement('div'); playerEl.className='player'; playerEl.textContent='üö∂'; mapEl.appendChild(playerEl); }
  const p = state.freeroam.player;
  const pos = tileToPixel(p.col, p.row);
  playerEl.style.left = pos.x + 'px'; playerEl.style.top = pos.y + 'px';
}

/* create town NPCs */
let townNPCs = [];
function populateTownNPCs(){
  townNPCs.forEach(n=> n.el && n.el.remove());
  townNPCs = [];
  const presets = [
    {col:6,row:2,emoji:'üë©‚Äçüç≥',name:'Chef Lily'},
    {col:10,row:5,emoji:'üë®‚Äçüåæ',name:'Farmer Joe'},
    {col:3,row:6,emoji:'üßë‚Äçüåæ',name:'Market Ida'}
  ];
  presets.forEach(p=>{
    const el = document.createElement('div'); el.className='npc'; el.textContent = p.emoji;
    mapEl.appendChild(el);
    el.style.left = tileToPixel(p.col,p.row).x + 'px';
    el.style.top = tileToPixel(p.col,p.row).y + 'px';
    el.title = p.name;
    el.addEventListener('click', ()=> talkToNPC(p));
    townNPCs.push({col:p.col,row:p.row,emoji:p.emoji,name:p.name,el});
  });
}

/* pixel position of tile center */
function tileToPixel(col,row){
  const tileSize = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--tile-size')) || 64;
  const gap = 2;
  const x = (col * (tileSize + gap)) + (tileSize/2) + 6;
  const y = (row * (tileSize + gap)) + (tileSize/2) + 6;
  return {x,y};
}

/* move player via click or keyboard */
function movePlayerTo(col,row){
  col = Math.max(0, Math.min(MAP_COLUMNS-1, col)); row = Math.max(0, Math.min(MAP_ROWS-1, row));
  state.freeroam.player.col = col; state.freeroam.player.row = row; placePlayer(); saveSoon(); checkFreeroamInteractions();
}
document.addEventListener('keydown', (e)=>{
  if(!freeroamActive) return;
  const p = state.freeroam.player;
  if(['ArrowUp','w','W'].includes(e.key)){ p.row = Math.max(0,p.row-1); movePlayerTo(p.col,p.row); e.preventDefault(); }
  if(['ArrowDown','s','S'].includes(e.key)){ p.row = Math.min(MAP_ROWS-1,p.row+1); movePlayerTo(p.col,p.row); e.preventDefault(); }
  if(['ArrowLeft','a','A'].includes(e.key)){ p.col = Math.max(0,p.col-1); movePlayerTo(p.col,p.row); e.preventDefault(); }
  if(['ArrowRight','d','D'].includes(e.key)){ p.col = Math.min(MAP_COLUMNS-1,p.col+1); movePlayerTo(p.col,p.row); e.preventDefault(); }
});

/* check interactions: NPCs, hidden items, shops */
function checkFreeroamInteractions(){
  const p = state.freeroam.player;
  // hidden items
  state.freeroam.hiddenItems.forEach((h,idx)=>{
    if(h.found) return;
    if(h.col===p.col && h.row===p.row){
      h.found = true;
      if(h.type === 'seeds'){ state.seeds += 2; toast('Found 2 seeds!'); log('Found seeds in town'); }
      else { state.money += 5; toast('Found $5!'); log('Found money in town'); }
      saveSoon(); renderGarden(); updateInventoryUI(); buildMapTiles(); placePlayer();
    }
  });
  // shop tile
  const tileIndex = p.row*MAP_COLUMNS + p.col; const tile = mapEl.children[tileIndex];
  if(tile && tile.classList.contains('shop')) openTownShop();
  // NPC proximity
  townNPCs.forEach(n => { if(n.col===p.col && n.row===p.row) talkToNPC(n); });
}

/* NPC dialog and quest creation */
function talkToNPC(npc){
  const dialog = document.getElementById('dialog'); dialog.innerHTML='';
  const title = document.createElement('div'); title.style.fontWeight='800'; title.textContent = `${npc.name} ${npc.emoji}`;
  const line = document.createElement('div'); line.style.marginTop='8px'; line.textContent = `Hi! I could use some help with crops.`;
  const actions = document.createElement('div'); actions.style.marginTop='12px'; actions.style.display='flex'; actions.style.gap='8px';
  const askQuest = document.createElement('button'); askQuest.textContent='Ask for quest';
  const shopBtn = document.createElement('button'); shopBtn.textContent='Open sidebar shop'; shopBtn.className='small ghost';
  const closeBtn = document.createElement('button'); closeBtn.textContent='Close'; closeBtn.className='small ghost';
  actions.appendChild(askQuest); actions.appendChild(shopBtn); actions.appendChild(closeBtn);
  dialog.appendChild(title); dialog.appendChild(line); dialog.appendChild(actions);
  askQuest.addEventListener('click', ()=> { createTownQuestFromNPC(npc); dialog.classList.add('hidden'); });
  shopBtn.addEventListener('click', ()=> { dialog.classList.add('hidden'); document.getElementById('shopList').scrollIntoView({behavior:'smooth'}); });
  closeBtn.addEventListener('click', ()=> dialog.classList.add('hidden'));
  dialog.classList.remove('hidden');
}

/* quest creation (NPC asks for multiple items) */
function createTownQuestFromNPC(npc){
  const plants = Object.keys(PLANTS); const want = plants[Math.floor(Math.random()*plants.length)]; const qty = 1 + Math.floor(Math.random()*2);
  const q = { id:'q'+Date.now(), npc:npc.name, want, qty, claimed:false, reward: 5 + Math.floor(Math.random()*8) };
  state.quests.push(q); saveSoon(); renderNpcQuests(); toast('New quest: '+npc.name+' wants '+qty+' '+want);
}

/* shop inside town: walk into shop tile to open (opens sidebar shop UI focus) */
function openTownShop(){
  toast('You entered the shop area. Use sidebar shop to buy items.');
}

/* ---------- Mode switching ---------- */
const gardenArea = document.getElementById('gardenArea');
const freeroamArea = document.getElementById('freeroamArea');

document.getElementById('btnFreeroam').addEventListener('click', ()=> enterFreeroam());
document.getElementById('btnGarden').addEventListener('click', ()=> exitFreeroam());
document.getElementById('btnOpenTown').addEventListener('click', ()=> enterFreeroam());
document.getElementById('btnReturnGarden').addEventListener('click', ()=> exitFreeroam());
function enterFreeroam(){
  gardenArea.style.display='none'; freeroamArea.style.display='flex'; freeroamActive=true; document.getElementById('btnFreeroam').classList.remove('ghost'); document.getElementById('btnGarden').classList.add('ghost');
  buildMapTiles(); populateTownNPCs(); placePlayer();
}
function exitFreeroam(){
  freeroamActive=false; freeroamArea.style.display='none'; gardenArea.style.display='block'; document.getElementById('btnGarden').classList.remove('ghost'); document.getElementById('btnFreeroam').classList.add('ghost'); saveSoon();
}

/* ---------- Water can quick buy & per-plot water button ---------- */
document.getElementById('btnBuyWater').addEventListener('click', ()=> {
  if(state.money >= 8){ state.money -= 8; state.waterCharges = (state.waterCharges||0) + 3; toast('Bought water can (+3)'); saveSoon(); updateInventoryUI(); updateHUD(); } else toast('Not enough money');
});
document.getElementById('btnUseWater').addEventListener('click', ()=> {
  if(state.waterCharges && state.waterCharges > 0){ state.waterCharges--; // water all planted plots once
    state.plots.forEach((p,i)=>{ if(p.planted && !p.weed && !p.pest) p.water = (p.water||0) + 1; });
    toast('Water used on planted plots'); saveSoon(); renderGarden(); updateInventoryUI();
  } else toast('No water charges');
});
document.getElementById('btnUseFert').addEventListener('click', ()=> {
  if(state.fertCount && state.fertCount>0){
    // fertilize all planted plots
    state.fertCount--; state.plots.forEach(p=>{ if(p.planted && !p.weed && !p.pest) p.growth = Math.min(p.growth+1, PLANTS[p.plantKey]?.growthStages || p.growth+1); });
    toast('Fertilizer applied to planted plots'); saveSoon(); renderGarden(); updateInventoryUI();
  } else toast('No fertilizer');
});
document.getElementById('btnScarecrow').addEventListener('click', ()=> {
  if(state.hasScarecrow){ toast('You already have a scarecrow'); return; }
  if(state.money >= 40){ state.money -= 40; state.hasScarecrow = true; toast('Scarecrow placed ‚Äî pest chance reduced'); saveSoon(); renderGarden(); updateHUD(); } else toast('Not enough money');
});
document.getElementById('btnUpgradeSoil').addEventListener('click', ()=> {
  // upgrade first non-rich plot for demo
  const idx = state.plots.findIndex(p=>p.soilQuality!=='rich');
  if(idx<0){ toast('All plots are rich'); return; }
  if(state.money >= 6){ state.money -= 6; state.plots[idx].soilQuality = 'rich'; toast('Upgraded soil on a plot'); saveSoon(); renderGarden(); } else toast('Not enough money');
});

/* Harvest all ready plots */
document.getElementById('btnHarvestAll').addEventListener('click', ()=>{
  let count = 0;
  state.plots.forEach(p=>{
    if(p.planted && p.growth >= PLANTS[p.plantKey].growthStages && !p.pest){
      state.inventory[p.plantKey] = (state.inventory[p.plantKey]||0) + 1;
      let base = PLANTS[p.plantKey].reward;
      if(p.soilQuality === 'rich') base = Math.round(base * 1.2);
      if(p.soilQuality === 'poor') base = Math.max(1, Math.round(base * 0.8));
      state.money += base; count++;
      p.planted=false; p.plantKey=null; p.growth=0; p.water=0; p.pest=false; p.weed=false;
    }
  });
  if(count>0){ toast('Harvested '+count+' crops'); saveSoon(); renderGarden(); updateInventoryUI(); updateHUD(); } else toast('No ready crops');
});

/* ---------- NPC Quests rendering ---------- */
function renderNpcQuests(){
  const el = document.getElementById('npcQuests'); el.innerHTML='';
  state.quests.forEach((q, i)=>{
    const row = document.createElement('div'); row.className='listItem';
    row.innerHTML = `<div>${q.npc} wants ${q.qty} ${PLANTS[q.want].emoji} ${q.want}</div><div>${q.claimed? 'Done' : (state.inventory[q.want]||0)+'/'+q.qty}</div>`;
    if(!q.claimed){ const btn=document.createElement('button'); btn.className='small'; btn.textContent='Give'; btn.addEventListener('click', ()=> tryCompleteQuest(i)); row.appendChild(btn); }
    el.appendChild(row);
  });
}

/* try complete */
function tryCompleteQuest(i){
  const q = state.quests[i]; if(!q || q.claimed) return;
  const have = state.inventory[q.want] || 0;
  if(have >= q.qty){ state.inventory[q.want] -= q.qty; q.claimed = true; state.money += q.reward; toast('Quest complete! +$'+q.reward); log('Quest complete: '+q.npc); saveSoon(); renderNpcQuests(); renderGarden(); updateInventoryUI(); updateHUD(); } else toast('Not enough items');
}

/* ---------- inventory & HUD ---------- */
function updateInventoryUI(){
  const inv = document.getElementById('inventory'); inv.innerHTML='';
  for(const k in PLANTS){ const cnt = state.inventory[k] || 0; const box=document.createElement('div'); box.className='invItem'; box.textContent = `${PLANTS[k].emoji} ${k}: ${cnt}`; inv.appendChild(box); }
  const w = document.createElement('div'); w.className='invItem'; w.textContent = `WaterCharges: ${state.waterCharges||0}`; inv.appendChild(w);
  const f = document.createElement('div'); f.className='invItem'; f.textContent = `Fertilizers: ${state.fertCount||0}`; inv.appendChild(f);
}
function updateHUD(){ document.getElementById('money').textContent = Math.floor(state.money||0); document.getElementById('seeds').textContent = state.seeds||0; document.getElementById('pots').textContent = state.pots||0; document.getElementById('waterCharges').textContent = state.waterCharges||0; document.getElementById('fertCount').textContent = state.fertCount||0; }

/* ---------- Save scheduling ---------- */
let saveTimer = null;
function saveSoon(){ if(saveTimer) return; saveTimer = setTimeout(()=>{ saveState(); saveTimer=null; }, 900); }

/* ---------- Freeroam hidden item collection periodic event ---------- */
function randomTownEvents(){
  if(Math.random() < 0.06) toast('Town: a market crowd gathers (small chance events)');
}
setInterval(randomTownEvents, 15000);

/* ---------- Init ---------- */
function init(){
  ensurePlots();
  buildPlantSelector();
  renderGarden();
  renderShop();
  renderNpcQuests();
  updateInventoryUI();
  updateHUD();
  exitFreeroam(); // default to garden
  log('Gardening 2.0 loaded. Use Water and Fertilizer, handle pests/weeds, upgrade soil & tools.');
}
function renderShop(){ const s=document.getElementById('shopList'); s.innerHTML=''; SHOP.forEach(it=>{ const r=document.createElement('div'); r.className='listItem'; r.innerHTML=`<div>${it.name}</div><div style="display:flex;gap:8px;align-items:center"><div>$${it.cost}</div><button data-id="${it.id}" class="small">Buy</button></div>`; s.appendChild(r); }); s.querySelectorAll('button[data-id]').forEach(b=>{ b.addEventListener('click', ()=>{ const id=b.dataset.id; const it=SHOP.find(x=>x.id===id); if(!it) return; if(state.money >= it.cost){ state.money -= it.cost; it.action(state); toast('Bought '+it.name); log('Bought '+it.name); saveSoon(); renderGarden(); renderShop(); updateInventoryUI(); updateHUD(); } else toast('Not enough money'); }); }); }
init();

/* ---------- Map & freeroam init helpers ---------- */
function buildMapTiles(){ mapEl.innerHTML=''; for(let r=0;r<MAP_ROWS;r++){ for(let c=0;c<MAP_COLUMNS;c++){ const t = document.createElement('div'); t.className='tile grass'; if(r===4 && c>=2 && c<=11) t.className='tile path'; if(r===2 && c===11) t.className='tile shop'; if(r===7 && c===2) t.className='tile water'; t.dataset.col=c; t.dataset.row=r; t.addEventListener('click', ()=> movePlayerTo(c,r)); mapEl.appendChild(t); } } // hidden items
  state.freeroam.hiddenItems = state.freeroam.hiddenItems || [];
  if(state.freeroam.hiddenItems.length === 0){
    for(let i=0;i<6;i++){
      state.freeroam.hiddenItems.push({col: 2 + Math.floor(Math.random()*(MAP_COLUMNS-4)), row: 1 + Math.floor(Math.random()*(MAP_ROWS-2)), found:false, type: Math.random()<0.6? 'seeds':'coins'});
    }
  }
  state.freeroam.hiddenItems.forEach(h=>{ if(!h.found){ const tileIndex = h.row*MAP_COLUMNS + h.col; const tile = mapEl.children[tileIndex]; if(tile) tile.classList.add('hiddenItem'); } });
}
function populateTownNPCs(){ townNPCs.forEach(n=> n.el && n.el.remove()); townNPCs = []; const presets=[ {col:6,row:2,emoji:'üë©‚Äçüç≥',name:'Chef Lily'}, {col:10,row:5,emoji:'üë®‚Äçüåæ',name:'Farmer Joe'}, {col:3,row:6,emoji:'üßë‚Äçüåæ',name:'Market Ida'} ]; presets.forEach(p=>{ const el=document.createElement('div'); el.className='npc'; el.textContent = p.emoji; mapEl.appendChild(el); el.style.left = tileToPixel(p.col,p.row).x+'px'; el.style.top = tileToPixel(p.col,p.row).y+'px'; el.title = p.name; el.addEventListener('click', ()=> talkToNPC(p)); townNPCs.push({col:p.col,row:p.row,emoji:p.emoji,name:p.name,el}); }); }
function tileToPixel(col,row){ const tileSize = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--tile-size')) || 64; const gap = 2; const x = (col * (tileSize + gap)) + (tileSize/2) + 6; const y = (row * (tileSize + gap)) + (tileSize/2) + 6; return {x,y}; }
function placePlayer(){ if(!playerEl){ playerEl = document.createElement('div'); playerEl.className='player'; playerEl.textContent='üö∂'; mapEl.appendChild(playerEl); } const p = state.freeroam.player; const pos = tileToPixel(p.col,p.row); playerEl.style.left = pos.x+'px'; playerEl.style.top = pos.y+'px'; }

/* ---------- Events ---------- */
document.getElementById('btnFreeroam').addEventListener('click', ()=> enterFreeroam());
document.getElementById('btnGarden').addEventListener('click', ()=> exitFreeroam());
document.getElementById('btnOpenTown').addEventListener('click', ()=> enterFreeroam());
document.getElementById('btnReturnGarden').addEventListener('click', ()=> exitFreeroam());

function enterFreeroam(){ document.getElementById('gardenArea').style.display='none'; document.getElementById('freeroamArea').style.display='flex'; freeroamActive=true; document.getElementById('btnFreeroam').classList.remove('ghost'); document.getElementById('btnGarden').classList.add('ghost'); buildMapTiles(); populateTownNPCs(); placePlayer(); }
function exitFreeroam(){ freeroamActive=false; document.getElementById('freeroamArea').style.display='none'; document.getElementById('gardenArea').style.display='block'; document.getElementById('btnGarden').classList.remove('ghost'); document.getElementById('btnFreeroam').classList.add('ghost'); saveSoon(); }

/* keyboard movement in freeroam handled above; check interactions after moving */
function checkFreeroamInteractions(){ const p = state.freeroam.player; // hidden items
  state.freeroam.hiddenItems.forEach(h=>{ if(!h.found && h.col===p.col && h.row===p.row){ h.found=true; if(h.type==='seeds'){ state.seeds += 2; toast('Found 2 seeds!'); log('Found seeds in town'); } else { state.money += 5; toast('Found $5!'); log('Found money in town'); } saveSoon(); renderGarden(); updateInventoryUI(); buildMapTiles(); placePlayer(); } }); // shop tile
  const tileIndex = p.row*MAP_COLUMNS + p.col; const tile = mapEl.children[tileIndex]; if(tile && tile.classList.contains('shop')) openTownShop(); townNPCs.forEach(n=>{ if(n.col===p.col && n.row===p.row) talkToNPC(n); }); }

/* open town shop (sidebar) */
function openTownShop(){ toast('Entered Shop zone ‚Äî use sidebar shop to buy.'); }

/* ---------- Save on unload ---------- */
window.addEventListener('beforeunload', ()=> saveState());

</script>
</body>
</html>
